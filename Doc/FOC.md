# FOC field orientied control 

## 1. Six-step commutation of brushless DC motor
The commutation operation is triggered when the rotor is in a specific position. The commutation is passive commutation. If you want to increase the speed, you must increase the current, so that the magnetic field generated by the stator is stronger, so that the rotor can reach the target point faster and then trigger the commutation, as shown in the table below.

## 2. How to get the angle of the rotor?
We already know that we need to detect the angle first and then commutate, so how to detect the current angle? There are the following three ways. 
1. Calculate the current angle by installing the **encoder**. 
2. Calculate the current angle by installing the **Hall sensor**.
3. Calcualte the current angle **decting the current**.
   
### 2. 1 Encoder method to obtain the current angle of the motor
There are two types of encoders, incremetal encoder and absolute encoder. 

Increemtal encoder: A calibration need to be done before each startup, and in order to prever the pulse loss caused by the performence of micro controller, ther encoder needs to be calibrated once per revolution. Therefore, the ABZ three-axis encoder is often used, and the AB output the orthogonal signal, z axis output the interruption. 

Absolute encoder, only one calibration needs to be done before leaving the factory, afterwards, if there is not disassembly, no calibration required. The communication method are generally SPI and I2C, and the influence of the communication time on the system needs to be considered. Why we need to do the calibration to the encoder, because we cannot ensure that the 0 angle of the encoder just correspond to the 0 angle of the rotor (eletrical angle: in general the default electrical angle is 0)

### 2.2 Hall sensor method to obtain the angle of the motor

### 2.3 Detecting of the current to botain the angle of the motor

Because of the rotation, the motor will generate some wave. Then we can detect the current to determine which range of the current of the motor is. 

## 3. field orientied control 
### 3.1 open loop of the FOC
We can review the process of learing brust direct current motor. First we need to rotate the motor and then we need to implement hte speed control ,and implement the position control. The same can be done during we learing FOC. First we ignore the position loop and the speed loop, then there is only leave the SVPMW and the part of current detection. Since we only need to make the rotor turn, the current detection is no more needed. We can directly give a target speed and target operation.

Compare to the six-step commutation method, the FOC will be more smooth and efficient.

### 3.2 introduction to IQ&ID
![](https://pic2.zhimg.com/80/v2-5ad65403fd235e0cf835825a887f7f65_720w.jpg)
looking closely, we can see that, it is ideal when the direction of the magnetic field generated by the three-winding is always tangential to the rotor magnet. In this way the rotational force is the largest which driving by the same current. When the direction of the magnetic field generated by three-winding is papendicular to the direction of the magnetic field , the rotor will be sucked in place, all of the current will be use to generate heat. So we set the rotor magnet as the reference, and then establish the coordinate DQ,  the DQ coordinate rotate with the rotor.

So how can we make the direction of the magnetic field generate by the winding be equivalent to the IQ and ID? Here we introduce the inverse Park transformation and the Clark inverse transformation.

#### 3.2.1 Inverse Park tranformation
![](https://pic1.zhimg.com/80/v2-1fe9b7613bf0e4e546faf82a34e33938_720w.jpg)
We know that the DQ coordinate system is a rotating coordinate system, but our three-phase windings are stationary, so the first task is to transform the rotating coordinate system into a stationary coordinate system, that is, to find a stationary coordinate system so that the magnetic field generated is equivalent to the DQ coordinate. , we name this coordinate system $αβ$ coordinate system, and the transformation process from DQ coordinate system to $αβ$ coordinate system is called **inverse Park transformation**.

$$
\begin{aligned}
U_α = U_d\cos θ - U_q \sin θ  \\
U_β = U_q\cos θ + U_d \sin θ    
\end{aligned}

$$
where the $\alpha$ axis is aligned with the phase a winding. 

After inverse Park transformation, we turn the rotating coordinate system into a stationary coordinate system, and the next step is to transform the stationary two-phase coordinate system to the 3-phase winding coordinate system.

#### 3.2.2 Inverse Clark Transformation
![](https://pic2.zhimg.com/80/v2-179c5210973a7cb6914add6761288a55_720w.jpg)
The purpose of Clark's inverse transformation is to *convert two vertical coordinate systems into three-phase winding coordinate systems*. After Clark inverse transformation, ID and IQ can be generated through three-phase windings. (Note that the reason why there is no Clark transformation in the FOC control block diagram is that only Iα and Iβ are needed through the simplification of the following formula)



But the hardware we can finally control is the conduction of the three-phase full bridge, that is, the six MOS tubes, so what we ultimately want is the conduction time of the MOS tubes, that is, the high level time of the timer output, that is, the duty cycle of the PWM ratio, so we need to find the Mos conduction time through Ua Ub Uc next.


### 3.3 Introduction to 8 vectors
We know that our input is to control the conduction time of Ua, Ub, Uc, and the rotor angle. Our goal (output) is ID & IQ. The problem we want to solve is how to generate output through input. Before solving the problem, we must first take a look at what our input is and what the physical meaning is. Since the two MOSs on the upper and lower sides of the same bridge arm cannot be turned on (short-circuited) at the same time, there are 8 states in total for the 6 MOSs. Since each state generates a magnetic field in a fixed direction, we call the 8 states 8 kinds of vectors.

![](https://pic2.zhimg.com/80/v2-c62a6c4cca6d1e8eb24d203f768e17f5_720w.jpg)

(Note: Vector 0 & 7 are 0 vector which have no size and direction)
| vector| A phase | B phase | C phase| 
| ---- | ---- |  ---- |  ---- | 
|0|	0|	0|	0|
|4|	1|	0|	0|
6|	1|	1|	0|
2|	0|	1|	0|
3|	0|	1|	1|
1|	0|	0|	1|
5|	1|	0|	1|
7|	1|	1|	1|

Assuming that our motor is at the 0° position, we only need to generate a 90° vector to make the motor rotate, then we only need half of the time that vector 2 and vector 6 act in one cycle to generate a 90°. In summary, we can control the direction of the vector by controlling the conduction time ratio of adjacent vectors, and change the size of the vector by inserting a 0 vector, so we can generate any direction and a vector of any size. (As long as we can generate a vector in any direction, we can first read the current rotor angle ID, and then **generate a vector that is 90 degrees ahead**, which is the IQ).


We know that the range of the vector direction is 0-360 degrees, so what is the size of the vector? Since the three-phase winding resistance is basically the same, the maximum value of each vector is $U_{dc} \cdot \frac{2}{3}$, where $U_{dc}$ is the bus voltage (power supply voltage). But we found that the maximum value of the vector is different in all directions. In order to make the motor rotate smoothly, the maximum value of our target vector should be the radius of the inscribed circle of the hexagon in the above figure, that is, $\frac{2}{3}U_{dc}\cdot \frac{\sqrt{3}}{2} = \frac{U_{dc}}{\sqrt{3}}$. So the maximum value of the traget vector should be $\frac{U_{dc}}{\sqrt{3}}$. Refer to the figure below for details.
![](https://pic3.zhimg.com/80/v2-86fe67b96888a285705f938f0ce86a42_720w.jpg)

## 3.4 generation of SVPWM
Let's see a example, if we want to generate a random vector between 0-60 degree.

![](https://pic2.zhimg.com/80/v2-6b047a91d1ceeb89a36a0e72524ed6ad_720w.jpg)

By calculation, we can get the vector action duration of several other sectors. Since all the results are basically the same format, we assume: 
$$
\begin{aligned}
K &= \sqrt{3} * Ts / U_{dc} \\
U_1 &= U_β \\
U_2 &= -\frac{\sqrt{3} }{2} * U_α - \frac{U_β}{2} \\
U_3 &= \frac{\sqrt{3} }{2} * U_α - \frac{U_β}{2} 
\end{aligned}
$$